name: ğŸ¸ Auto-Update Site

on:
  push:
    paths:
      - 'Base de connaissances/**'
      - '!Base de connaissances/**/assets/**'
    branches:
      - main
  workflow_dispatch:  # Permet de lancer manuellement depuis GitHub

jobs:
  update-site:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # RÃ©cupÃ¨re tout l'historique
      
      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: ğŸ“Š VÃ©rifier les fichiers modifiÃ©s
        id: check_files
        run: |
          echo "Fichiers modifiÃ©s :"
          git diff --name-only HEAD~1 HEAD | grep "songs_index.json" || echo "Aucun songs_index.json modifiÃ©"
          
          if git diff --name-only HEAD~1 HEAD | grep -q "songs_index.json"; then
            echo "needs_update=true" >> $GITHUB_OUTPUT
          else
            echo "needs_update=false" >> $GITHUB_OUTPUT
          fi
      
      - name: ğŸ¸ Lancer update-site.py
        if: steps.check_files.outputs.needs_update == 'true'
        run: |
          echo "ğŸ¸ Mise Ã  jour du site..."
          python3 update-site.py
      
      - name: ğŸ“Š Afficher les statistiques
        if: steps.check_files.outputs.needs_update == 'true'
        run: |
          if [ -f megasearch.json ]; then
            echo "ğŸ“ˆ Statistiques du megasearch.json :"
            echo "Taille : $(du -h megasearch.json | cut -f1)"
            echo "Ressources : $(grep -o '"total":' megasearch.json | wc -l)"
          fi
      
      - name: ğŸ”„ Commit et push les changements
        if: steps.check_files.outputs.needs_update == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "GitHub Actions Bot"
          
          # Ajouter les fichiers modifiÃ©s
          git add megasearch.json
          git add index.html
          
          # VÃ©rifier s'il y a des changements
          if git diff --staged --quiet; then
            echo "âœ… Aucun changement Ã  commit"
          else
            # Compter les nouvelles ressources
            TOTAL=$(python3 -c "import json; data=json.load(open('megasearch.json')); print(data['total'])")
            METHODS=$(python3 -c "import json; data=json.load(open('megasearch.json')); print(data['stats']['total_methods'])")
            
            git commit -m "ğŸ¤– Auto-update: $TOTAL ressources, $METHODS mÃ©thodes [skip ci]"
            git push
            
            echo "âœ… Changements poussÃ©s sur GitHub"
          fi
      
      - name: ğŸ“¢ Notification de succÃ¨s
        if: steps.check_files.outputs.needs_update == 'true'
        run: |
          echo "::notice::âœ… Site mis Ã  jour automatiquement !"
      
      - name: âš ï¸ Aucune mise Ã  jour nÃ©cessaire
        if: steps.check_files.outputs.needs_update == 'false'
        run: |
          echo "::notice::â„¹ï¸ Aucun songs_index.json modifiÃ©, pas de mise Ã  jour nÃ©cessaire"
