name: ğŸ” Auto OCR Assets Scanner

on:
  push:
    branches:
      - main
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * *'

jobs:
  ocr-scan:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: ğŸ“¦ Install Tesseract OCR
        run: |
          sudo apt-get update
          sudo apt-get install -y tesseract-ocr tesseract-ocr-eng tesseract-ocr-fra
          tesseract --version
      
      - name: ğŸ“š Install Python dependencies
        run: |
          pip install --upgrade pip
          pip install Pillow pytesseract beautifulsoup4 lxml
      
      - name: ğŸ” Count images in assets folders
        run: |
          echo "ğŸ“Š Counting images in assets folders..."
          find . -type f \( -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" \) -path "*/assets/*" ! -path "./.git/*" | wc -l
      
      - name: ğŸ¯ Run OCR Assets Scanner
        run: |
          echo "ğŸ” Starting OCR scan on assets folders..."
          echo "âš ï¸  Only scanning images in **/assets/** folders"
          python3 ocr-assets-scanner.py --repo . --output assets_ocr_index.json
          echo "âœ… OCR scan completed"
      
      - name: ğŸ“Š Display OCR results
        run: |
          if [ -f assets_ocr_index.json ]; then
            echo "âœ… OCR Index created successfully"
            echo ""
            echo "ğŸ“ˆ Quick stats:"
            grep -o '"total_scanned":[0-9]*' assets_ocr_index.json || true
            grep -o '"new_scans":[0-9]*' assets_ocr_index.json || true
          else
            echo "âŒ OCR index not created"
          fi
      
      - name: ğŸ”„ Merge all indexes
        run: |
          echo "ğŸ”„ Merging all JSON indexes..."
          if [ -f fusion-all-indexes.py ]; then
            python3 fusion-all-indexes.py --repo . --output mega-search-index.json
            echo "âœ… mega-search-index.json updated"
          else
            echo "âš ï¸  fusion-all-indexes.py not found, skipping merge"
          fi
      
      - name: ğŸ“Š Display mega-index stats
        run: |
          if [ -f mega-search-index.json ]; then
            echo "âœ… Mega Index created successfully"
            echo ""
            echo "ğŸ“ˆ Quick stats:"
            grep -o '"total_resources":[0-9]*' mega-search-index.json || true
            grep -o '"with_ocr":[0-9]*' mega-search-index.json || true
          else
            echo "âŒ Mega index not created"
          fi
      
      - name: ğŸ’¾ Commit and Push results
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add assets_ocr_index.json mega-search-index.json || true
          
          if git diff --staged --quiet; then
            echo "ğŸ“ No changes to commit"
          else
            echo "ğŸ’¾ Committing changes..."
            git commit -m "ğŸ” Auto-update: OCR assets scan + indexes [skip ci]"
            
            echo "ğŸ“¥ Pulling latest changes..."
            git pull --rebase origin main || true
            
            echo "ğŸ“¤ Pushing changes..."
            for i in {1..3}; do
              if git push; then
                echo "âœ… Changes pushed successfully"
                break
              else
                echo "âš ï¸  Push failed (attempt $i/3), retrying..."
                sleep 5
                git pull --rebase origin main || true
              fi
            done
          fi
      
      - name: ğŸ“ˆ Final Summary
        if: always()
        run: |
          echo ""
          echo "=================================================="
          echo "ğŸ¸ Prof de Basse - OCR Assets Scan Complete"
          echo "=================================================="
          echo ""
          if [ -f assets_ocr_index.json ]; then
            echo "âœ… OCR Index: assets_ocr_index.json"
          else
            echo "âŒ OCR Index: NOT CREATED"
          fi
          if [ -f mega-search-index.json ]; then
            echo "âœ… Mega Index: mega-search-index.json"
          else
            echo "âŒ Mega Index: NOT CREATED"
          fi
          echo ""
          echo "ğŸ”— View workflow: https://github.com/${{ github.repository }}/actions"
          echo "=================================================="
